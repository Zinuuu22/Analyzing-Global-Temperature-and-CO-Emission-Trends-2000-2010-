---
title: "CH4 vs CO2"
author: "Nguyen Quoc Khanh"
date: "2025-03-19"
output: html_document
---

```{r}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(hexbin)
library(patchwork)
library(ggfortify)
library(scales)
library(RColorBrewer)
library(GGally)
```


#merge data CO2 and CH4
```{r}
# Read the datasets
ch4_data <- read.csv("C:/Users/ADMIN/Documents/Document/USTH/B3/Spatial analysis/ch4_2000_2010.csv")
co2_data <- read.csv("C:/Users/ADMIN/Documents/Document/USTH/B3/Spatial analysis/co2_2000_2010.csv")

# Rename columns to avoid conflicts
names(ch4_data)[3:4] <- c("average_CH4", "trend_CH4")
names(co2_data)[3:4] <- c("average_CO2", "trend_CO2")

# Merge the datasets
merged_data <- merge(ch4_data, co2_data, by = c("Year", "Month"))

# Check the merged data
head(merged_data)

# Save the merged data (optional)
write.csv(merged_data, "C:/Users/ADMIN/Documents/Document/USTH/B3/Spatial analysis/merged_CO2_CH4_data.csv", row.names = FALSE)
```

##Bivariate Analysis

```{r}
# Create scatter plot
ggplot(merged_data, aes(x = average_CO2, y = average_CH4)) +
  geom_point(color = "darkred", alpha = 0.7) +
  geom_smooth(method = "lm", color = "navy", se = FALSE) +
  labs(title = "Scatter Plot of CO2 vs CH4 Concentration (2000-2010)",
       x = "CO2 Concentration (ppm)",
       y = "CH4 Concentration (ppb)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

# Save the plot (optional)
ggsave("C:/Users/ADMIN/Documents/Document/USTH/B3/Spatial analysis/CO2_CH4_scatterplot.png", 
       width = 8, height = 6, dpi = 300)
```
```{r}
# Create Hexbin Density Plot
ggplot(merged_data, aes(x = average_CH4, y = average_CO2)) +
  geom_hex(bins = 30) +  # Adjust bin number for resolution
  scale_fill_viridis_c(option = "plasma", name = "Density") +  # Viridis color scale
  labs(title = "Hexbin Density Plot of CH4 vs CO2 Concentrations (2000-2010)",
       x = "CH4 Concentration (ppb)",
       y = "CO2 Concentration (ppm)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "right")
```

```{r}
# Create Hexbin Density Plot
ggplot(merged_data, aes(x = average_CH4, y = average_CO2)) +
  geom_hex(bins = 30) +  # Adjust bin number for resolution
  scale_fill_viridis_c(option = "plasma", name = "Density") +  # Viridis color scale
  labs(title = "Hexbin Density Plot of CH4 vs CO2 Concentrations (2000-2010)",
       x = "CH4 Concentration (ppb)",
       y = "CO2 Concentration (ppm)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "right")

```
```{r}
# Box Plot 1: CO2 distribution across CH4 ranges (FIXED)
p1 <- ggplot(merged_data, aes(x = cut(average_CH4, breaks = 5), y = average_CO2)) +  # Added closing )
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "CO2 Distribution Across CH4 Ranges",
       x = "CH4 Concentration Ranges (ppb)",
       y = "CO2 Concentration (ppm)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Box Plot 2: CH4 distribution across CO2 ranges
p2 <- ggplot(merged_data, aes(x = cut(average_CO2, breaks = 5), y = average_CH4)) +
  geom_boxplot(fill = "salmon", color = "black") +
  labs(title = "CH4 Distribution Across CO2 Ranges",
       x = "CO2 Concentration Ranges (ppm)",
       y = "CH4 Concentration (ppb)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Display plots side-by-side
p1 + p2
```
```{r}
# Calculate correlation between CH4 and CO2
correlation <- cor(merged_data$average_CH4, merged_data$average_CO2, use = "complete.obs")

# Print the result
print(paste("Correlation Coefficient between CH4 and CO2:", round(correlation, 3)))
```
##Multivariate Analysis

```{r}
# Load required package
library(reshape2)

# Correlation matrix
cor_matrix <- round(cor(merged_data[,3:6], use = "complete.obs"), 2)
melted_cor <- melt(cor_matrix)

# Heatmap visualization
ggplot(melted_cor, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = value), color = "black", size = 4) +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                      midpoint = 0, limit = c(-1,1)) +
  labs(title = "Correlation Matrix: Greenhouse Gas Concentrations",
       x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
# Create date column
merged_data$Date <- as.Date(paste(merged_data$Year, merged_data$Month, "1"), 
                          "%Y %m %d")

# Time series plot
ggplot(merged_data, aes(x = Date)) +
  geom_line(aes(y = average_CH4, color = "CH4")) +
  geom_line(aes(y = average_CO2/5, color = "CO2")) + # Scaling for visualization
  scale_y_continuous(sec.axis = sec_axis(~.*5, name = "CO2 (ppm)")) +
  labs(title = "Temporal Trends of Greenhouse Gases",
       y = "CH4 (ppb)",
       color = "Gas") +
  scale_color_manual(values = c("CH4" = "darkgreen", "CO2" = "orange")) +
  theme_minimal()
```

```{r}
# K-means clustering
set.seed(123)
gas_clusters <- kmeans(scale(merged_data[,3:4]), centers = 3)

# Add clusters to data
merged_data$Cluster <- as.factor(gas_clusters$cluster)

# Cluster visualization
ggplot(merged_data, aes(average_CH4, average_CO2, color = Cluster)) +
  geom_point(alpha = 0.7) +
  labs(title = "CO2-CH4 Concentration Clusters",
       x = "CH4 (ppb)",
       y = "CO2 (ppm)") +
  theme_minimal()
```

```{r}
# Model CH4 as function of CO2 and trends
model <- lm(average_CH4 ~ average_CO2 + trend_CH4 + trend_CO2, data = merged_data)

# Model summary
summary(model)

# Diagnostic plots
par(mfrow = c(2,2))
plot(model)
```




